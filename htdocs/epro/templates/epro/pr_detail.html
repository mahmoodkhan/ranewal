{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% load customtags %}

{% block content %}

<div class="panel panel-info">
    <!-- Default panel contents -->
    <div class="panel-heading">
        {{ pr }} 
        <div role="group" class="btn-group btn-group-xs pull-right">
            <button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class= "glyphicon glyphicon-menu-hamburger"> </span> PR options
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li><a href="#"><span class="glyphicon glyphicon-send"></span> Submit</a></li>
                <li><a href="#"><span class="glyphicon glyphicon-print"></span> Print</a></li>
                <li><a href="#"><span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                <li><a href="#"><span class="glyphicon glyphicon-exclamation-sign"></span> Cancel</a></li>
                <li class="divider"></li>
                <li><a href="#" style="color: #FF0000 !important;"><span class="glyphicon glyphicon-trash"></span> Delete</a></li>
            </ul>
        </div>
    </div>

    <div class="clearfix"></div>
    <div class="table-responsive">
        <table class = "table table-bordered table-condensed">
        <tr>
            <td colspan="4">
                <span class="label label-default">Delivery Address</span>
                <span class="label label-primary">{{ pr.delivery_address }}</span>
            </td>
            <td>
                <span class="label label-default">Required Date</span>
                <span class="label label-danger">{{ pr.required_date|date }} &nbsp; ({{ pr.required_date|get_due_date_string }})</span>
            </td>
        </tr>
        <tr>
            <td>
                <span class="label label-default">Country</span>
                <span class="label label-primary">{{ pr.country }}</span>
            </td>
            <td>
                <span class="label label-default">Office</span>
                <span class="label label-primary">{{ pr.office|default_if_none:"not specified" }}</span>
            </td>
            <td>
                <span class="label label-default">Currency</span>
                <span class="label label-primary">{{ pr.currency }}</span>
            </td>
            <td>
                <span class="label label-default">USD Exchange Rate</span>
                <span class="label label-primary">{{ pr.dollar_exchange_rate }}</span>
            </td>
        </tr>
        <tr>
            <td>
                <span class="label label-default">Originator</span>
                <span class="label label-primary">{{ pr.originator }}</span>
            </td>
            <td>
                <span class="label label-default">Date Originated</span>
                <span class="label label-primary">{{ pr.origination_date|date }}</span>
            </td>
            <td>
                <span class="label label-default">Date Submitted</span>
                <span class="label label-primary">{{ pr.submission_date|date }}</span>
            </td>
            <td>
                <span class="label label-default">Approver 1</span>
                <span class="label label-primary">{{ pr.approver1|default_if_none:"" }} approved on {{ pr.approval1_date|date }} </span>
            </td>
            <td>
                <span class="label label-default">Approver 2</span>
                <span class="label label-primary">{{ pr.approver2|default_if_none:"" }} approved on {{ pr.approval2_date|date }}</span>
            </td>
        </tr>
        <tr>
            <td>
                <span class="label label-default">Fin. Review</span>
                <span class="label label-primary">{{ pr.finance_reviewer|default_if_none:"" }} reviewed on {{ finance_review_date|date }} </span>
            </td>
        </tr>
    </table>
    </div>

    <div class="panel-body">
        <p> Below is a list of all the items that have been added to this PR</p>
    </div>
    <div class = "table-responsive">
        <table id="pr_items_table" class="table table-bordered table-striped table-hover table-condensed">
            <tr>
                <th>Qty</th>
                <th>Unit</th>
                <th>Description</th>
                <th>Cost</th>
                <th>Total</th>
                <th>Cost $</th>
                <th>Total $</th>
                <th style="width: 45px;"></th>
            </tr>
            {% for item in pr.items.all %}
                <tr>
                    <td> {{ item.quantity_requested }} </td>
                    <td> {{ item.unit }} </td>
                    <td> {{ item.description_pr|urlizetrunc:15|url_target_blank|safe }} </td>
                    <td> {{ item.price_estimated_local }} </td>
                    <td> {{ item.price_estimated_local_subtotal }} </td>
                    <td> {{ item.price_estimated_usd }} </td>
                    <td> {{ item.price_estimated_usd_subtotal }} </td>
                    <td>
                        <a href="{% url 'item_edit' item.pk %}" id='edit_item_link'><span class="glyphicon glyphicon-edit"></span></a>
                        <a href="#" style="color:red;"><span class="glyphicon glyphicon-trash"></span></a>
                    </td>
                </tr>
            {% endfor %}
            <tfoot>
                <tr class="info">
                    <td colspan="4"></td>
                    <td>{{ total_usd }}</td>
                    <td></td>
                    <td colspan=2>{{ total_local }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="panel-footer" id="pr_panel_footer_div">
        <div role="group" class="btn-group btn-group-xs">
            <a href="{% url 'item_new' pr.pk %}" id="add_item_link" type="button" class="btn btn-warning btn-xs"><span class="glyphicon glyphicon-modal-window"> </span> Add Item</a>
        </div>
    </div>
</div>

<div class="modal fade" id="pritem_modal_div" tabindex="-1" role="dialog" aria-labelledby="form_modal_label" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content" id="pr_items_modal_content_div">

        </div>
    </div>
</div>
{% endblock content %}
<!-- http://damienfremont.com/2014/12/19/how-to-expandcollapse-table-rows-with-bootstrap/ -->
{% block extra_js %}
<script type = "text/javascript">

    $(document).ready(function() { 
        //$('#pritems_tabs_ul a[href="#financecodes_tab_div"]').hide();

        $("#id_fund_code").select2();
        $("#id_dept_code").select2();
        $("#id_office_code").select2();
    });

    $('#pr_items_table').on('click', '#edit_item_link', function(e) {
        e.preventDefault();
        $("#pr_items_modal_content_div").load($(this).attr("href"), "#item_edit_div");
        $('#pritem_modal_div').modal('show');
    });

    $('#pr_panel_footer_div').on('click', '#add_item_link', function(e) {
        e.preventDefault();
        $("#pr_items_modal_content_div").load($(this).attr("href"), "#item_edit_div");
        $('#pritem_modal_div').modal('show');
    });
    

    // Stop HTTP Posting of Item form; submit it via AJAX
    $('#pritem_modal_div').on('submit', '#id_pr_item_form', function(e) {
        e.preventDefault();
        var url = $(this).attr('action');
        var data = $(this).serialize();
        
        $.ajax({
            method: 'POST',
            url: url,
            data: data,
            global: false,
            })
            .done(function(data, textStatus, jqXHR) {
                item = data['object'][0];
                // Show the Finance Codes tab now that an item has been saved.
                $('#pritems_tabs_ul a[href="#financecodes_tab_div"]').show();
                $('#pritems_tabs_ul a[href="#financecodes_tab_div"]').trigger('click');
                
                var json = $.parseJSON(jqXHR.responseText);
                show_django_ajax_messages(json, "#modal_messages");
            });
        
        /*
        $.post(url, data)
            .done(function(data, textStatus, jqXHR) {
                item = data['object'][0];
                // Show the Finance Codes tab now that an item has been saved.
            
                $('#pritems_tabs a[href="#finance_codes_tab"]').show();
                $('#pritems_tabs a[href="#finance_codes_tab"]').trigger('click');
            }); */
    });
    $('#pritem_modal_div').on('hidden.bs.modal', function (e) {
        $("#pr_items_modal_content_div").empty();
    });
</script>
{% endblock extra_js %}
