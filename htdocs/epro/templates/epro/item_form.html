{% load crispy_forms_tags %}

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title">{% if item.pk %} Updating Item {% else %} Adding Item {% endif %}</h4>
    <span id="modal_messages"></span>
</div>
<div class="modal-body">
    <!-- Nav tabs -->
    <ul id="pr_items_tabs_ul" class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#item_tab" aria-controls="item_form" role="tab" data-toggle="tab"> Item</a>
        </li>
        <li role="presentation">
            <a href="#financecodes_tab" aria-controls="finance_codes_form" role="tab" data-toggle="tab"> Finance Codes</a>
        </li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="item_tab"><br />{% crispy form %}</div>
        <div role="tabpanel" class="tab-pane" id="financecodes_tab">
            <div class = "table-responsive">
                <table id="finance_codes_table" class="table table-bordered table-striped table-hover table-condensed">
                    <tr>
                        <th style="display:none;">ItemId</th>
                        <th style="display:none;">FinanceCodesId</th>
                        <th>GL</th>
                        <th style="display:none;">FundId</th>
                        <th>Fund</th>
                        <th style="display:none;">DeptId</th>
                        <th>Dept</th>
                        <th style="display:none;">OfficeId</th>
                        <th>Office</th>
                        <th>LIN</th>
                        <th>Activity</th>
                        <th>Emp ID</th>
                        <th>% Alloc</th>
                        <th style="display:none;"></th>
                        <th></th>
                    </tr>
                    {% for fc in item.finance_codes.all %}
                        <tr>
                            <td style="display:none;">{{ item.pk }}</td>
                            <td style="display:none;">{{ fc.pk }}</td>
                            <td>{{ fc.gl_account }}</td>
                            <td style="display:none;">{{ fc.fund_code.pk }}</td>
                            <td>{{ fc.fund_code }}</td>
                            <td style="display:none;">{{ fc.dept_code.pk }}</td>
                            <td>{{ fc.dept_code }}</td>
                            <td style="display:none;">{{ fc.office_code.pk }}</td>
                            <td>{{ fc.office_code }}</td>
                            <td>{{ fc.lin_code }}</td>
                            <td>{{ fc.activity_code }}</td>
                            <td>{{ fc.employee_id }}</td>
                            <td>{{ fc.allocation_percent }}</td>
                            <td style="display:none;">{{ fc.default_for_new_items }}</td>
                            <td>
                                <a href="{% url 'financecodes_edit' fc.pk %}" data-finance-codes-id={{ fc.pk }} class="edit"><span class="glyphicon glyphicon-edit"></span></a>
                                <a href={% url 'financecodes_edit' fc.pk %} data-finance-codes-id={{ fc.pk }} class="del" style="color:red;"><span class="glyphicon glyphicon-trash"></span></a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            {% crispy finance_codes_form %}
    </div>
</div>
{% block extra_js %}
<script type = "text/javascript">

    // Upon activating the Item tab, set the quantity field on focus.
    $('#pr_items_tabs_ul a[href="#item_tab"]').on('shown.bs.tab', function (e) {
        $("#id_quantity_requested").focus();
    });

    // Upon activating the FinanceCodes tab, set the GL_Account field on focus.
    $('#pr_items_tabs_ul a[href="#financecodes_tab"]').on('shown.bs.tab', function (e) {
        $("#id_gl_account").focus();
    });

    // Upon clicking the EDIT button FinanceCodes, update the FinanceCodes action url
    $('#finance_codes_table').on('click', 'a.edit', function(e) {
        e.preventDefault();

        // Set the FinanceCodes form action url to be that of the clicked edit button.
        $("#id_finance_codes_form").attr("action",  $(this).attr('href'));

        // Get the FinanceCodes ID from the edit button that was clicked.
        var finance_codes_pk = $(this).data("financeCodesId");
        
        // Set the financeCodesId value as HTML5 data attribute on the form submit button,
        // which is later used in the form submit event to determine what row in the table 
        // above the form to update.
        $("#id_submit_finance_codes_btn").data('fcid', finance_codes_pk);

        // Get all of the td elements and extract its values to populate the form
        var tds = $(this).closest("tr").children();      
        $("#id_gl_account").val(parseInt($(tds[2]).text()));
        $("#id_fund_code").select2().val( parseInt($(tds[3]).text()) ).trigger("change");
        $("#id_dept_code").select2().val( parseInt($(tds[5]).text()) ).trigger("change");
        $("#id_office_code").select2().val( parseInt($(tds[7]).text()) ).trigger("change");
        $("#id_lin_code").val( $.trim($(tds[9]).text()) );
        $("#id_activity_code").val( $.trim($(tds[10]).text()) );
        $("#id_employee_id").val( parseInt($.trim($(tds[11]).text())) );
        $("#id_allocation_percent").val( parseInt($.trim($(tds[12]).text())) );
        $("#id_default_for_new_items").prop('checked', Boolean($.trim($(tds[13]).text()) == 'True' ));
    });

    // Upon clicking the Cancel button of the FinanceCodes form, set the FinanceCodes form action to add
    $("#id_finance_codes_form").on("click", "#id_cancel_finance_codes_btn", function(e) {

        {% if item.pk %}
            // reset the form action to add finance codes not edit.
            $("#id_finance_codes_form").attr("action",  "{% url 'financecodes_new' item.pk %}");
        {% else %}
            var url = "{% url 'financecodes_new' 0 %}";
            url = url.replace('0', $("#id_finance_codes_form #id_item_id").val());
            $("#id_finance_codes_form").attr("action",  url);
        {% endif %}
        // reset the dropdowns with select2 manually b/c reset button cannot reset them.
        $("#id_fund_code").select2().val("").trigger("change");
        $("#id_dept_code").select2().val("").trigger("change");
        $("#id_office_code").select2().val("").trigger("change");
    });

</script>
{% endblock extra_js %}