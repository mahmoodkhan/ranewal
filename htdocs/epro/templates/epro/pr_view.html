{% extends 'base.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{%load humanize %}
{% load customtags %}

{% block content %}

<div class="panel panel-primary">
    <div class="panel-heading">
        <div role="group" class="btn-group btn-group-xs pull-right">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class= "glyphicon glyphicon-menu-hamburger"> </span>
                <!--<span class="caret"></span>-->
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li><a href="#"><span class="glyphicon glyphicon-send"></span> Submit</a></li>
                <li><a href="#"><span class="glyphicon glyphicon-print"></span> Print</a></li>
                <li><a href="{% url 'pr_edit' pr.pk %}" id="pr_edit_btn" class="text-muted" data-toggle="modal" data-target="#pr_form_modal_div"><span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                <li><a href="#"><span class="glyphicon glyphicon-exclamation-sign"></span> Cancel</a></li>
                <li class="divider"></li>
                <li><a href="#" style="color: #FF0000 !important;"><span class="glyphicon glyphicon-trash"></span> Delete</a></li>
            </ul>
        </div>
        <h3 class="panel-title">{{ pr }}</h3>
        <div class="clearfix"></div>
    </div>

    <div class="table-responsive">
        <table class = "table table-bordered table-condensed">
            <tr style="white-space:normal;">
                <td colspan="5" style="white-space: normal;">
                    <div class="orderStatus">
                        <ul class="row">
                            <li class="col done">Originated on {{ pr.origination_date|date }} by {{ pr.originator }}</li>
                            {% if pr.procurement_review_requested_date %}
                                <li class="col done">Procurement Review Requested on {{ pr.procurement_review_requested_date|date }} </li>
                            {% else %}
                                <li class="col">Procurement Review Request Pending</li>
                            {% endif %}
                            {% if pr.procurement_review_date %}
                                <li class="col done">Procurement Review  {% if pr.procurement_review_date %} Completed on {{ pr.procurement_review_date|date }} by {{ pr.procurement_review_done_by }} {% endif %}</li>
                            {% else %}
                                <li class="col">Procurement Review Pending</li>
                            {% endif %}

                            {% if pr.approval1_requested_date %} 
                                <li class="col done">Fund Approval 1 Requested on {{ approval1_requested_date|date }}</li>
                            {% else %}
                                <li class="col">Fund Approval 1 Request to {{ pr.approver1 }}</span> Pending</li>
                            {% endif %}

                            {% if pr.approval1_date %}
                                    <li class="col done">Fund Approval 1 Completed on {{ pr.approval1_date|date }} by {{ pr.approver1 }} </li>
                            {% else %}
                                    <li class="col">Fund Approval 1 Pending</li>
                            {% endif %}

                            {% if pr.approver2 %}
                                {% if pr.approval2_requested_date %} 
                                    <li class="col">Fund Approval 2 Requested on {{ approval2_requested_date|date }}</li>
                                {% else %}
                                    <li class="col">Fund Approval 2 Request Pending</li>
                                {% endif %}

                                {% if pr.approval2_date %}
                                    <li class="col done">Fund Approval 2 Completed on {{ pr.approval2_date|date }} by {{ pr.approver2 }} </li>
                                {% else %}
                                    <li class="col">Fund Approval 2 Pending</li>
                                {% endif %}
                            {% endif %}
                            {% if pr.finance_review_requested_date %}
                                <li class="col done">Financial Review Requested on {{ pr.finance_review_requested_date|date }}</li>
                            {% else %}
                                <li class="col">Financial Review Request Pending</li>
                            {% endif %}

                            {% if pr.finance_review_date %}
                                <li class="col done">Financial Review Completed on {{ pr.finance_review_date|date}} by {{ pr.finance_reviewer }} </li>
                            {% else %}
                                <li class="col">Financial Review Pending</li>
                            {% endif %}

                            {% if pr.submission_date %}
                                <li class="col done">PR Submitted on {{ pr.submission_date|date }} for Processing</li>
                            {% else %}
                                <li class="col">PR Submission Pending</li>
                            {% endif %}

                            {% if pr.status == 'Completed' %}
                                <li class="col done">Completed</li>
                            {% else %}
                                <li class="col">Completed</li>
                            {% endif %}
                        </ul>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <span class="label label-default">Delivery Address:</span>&nbsp;<span class="label label-primary">{{ pr.delivery_address|default_if_none:"not specified" }}</span>
                    <div class="pull-right"><span class="label label-default">Required Date</span> <span class="label label-danger">{{ pr.required_date|date }} &nbsp; ({{ pr.required_date|get_due_date_string }})</span></div>
                </td>
            </tr>
        </table>
    </div>
    <div class="clearfix"></div>
    <!--
    <div class="panel-body">
        <span class="glyphicon glyphicon-ok" style="color:green;"></span>
    </div>
    -->
    <div class = "table-responsive">
        <table id="pr_items_table" class="table table-bordered table-striped table-hover table-condensed">
            <tr>
                <th style="width: 25px;"></th>
                <th>#</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Description</th>
                <th>Cost</th>
                <th>Total</th>
                <th>Cost_$</th>
                <th>Total_$</th>
                <th style="width: 45px;"></th>
            </tr>
            {% for item in pr.items.all %}
                <tr>
                    <td><a tabindex="0" role="button" data-toggle="popover" data-trigger="focus" data-content="Missing Finance Codes. Either add a default one or add for each item."><span class="glyphicon glyphicon-exclamation-sign" style="color:red;"></span></a></td>
                    <td>{{ item.item_sno }}</td>
                    <td> {{ item.quantity_requested }} </td>
                    <td> {{ item.unit }} </td>
                    <td> {{ item.description_pr|urlizetrunc:15|url_target_blank|safe }} </td>
                    <td> {{ item.price_estimated_local }} </td>
                    <td> {{ item.price_estimated_local_subtotal }} </td>
                    <td> {{ item.price_estimated_usd }} </td>
                    <td> {{ item.price_estimated_usd_subtotal }} </td>
                    <td>
                        <a href="{% url 'item_edit' item.pk %}" data-item-id={{ item.pk }} id='edit_item_link'><span class="glyphicon glyphicon-edit"></span></a>
                        <a href="#" data-href="/item/delete/1/" data-toggle="modal" data-target="#confirm-delete" style="color:red;"><span class="glyphicon glyphicon-trash"></span></a>
                    </td>
                </tr>
            {% endfor %}
            <tfoot>
                <tr class="info">
                    <td colspan="6">
                        <span class="label label-default">PR Currency</span>
                        <span class="label label-primary">{{ pr.currency }}</span>

                        <span class="label label-default">USD Exchange Rate</span>
                        <span class="label label-primary">{{ pr.dollar_exchange_rate }}</span>
                    </td>
                    <td>{{ total_local|floatformat:"2"|intword|intcomma }}</td>
                    <td></td>
                    <td colspan=2>{{ total_usd|floatformat:"2"|intword|intcomma }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="panel-footer" id="pr_panel_footer_div">
        <div role="group" class="btn-group btn-group-sm pull-right">
            <a href="{% url 'item_new' pr.pk %}" id="add_item_link" type="button" class="btn btn-default"><span class="glyphicon glyphicon-plus"> </span> Add Item</a>
        </div>
        <div class="clearfix"></div>
    </div>
</div>

<div class="modal fade" id="pr_items_modal_div" tabindex="-1" role="dialog" aria-labelledby="pr_items_modal_div_label" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content" id="pr_items_modal_content_div">

        </div>
    </div>
</div>

{% endblock content %}
<!-- http://damienfremont.com/2014/12/19/how-to-expandcollapse-table-rows-with-bootstrap/ -->
{% block extra_js %}
<script type = "text/javascript">

    $(function () {
  $('[data-toggle="popover"]').popover()
});
    // When the modal loads, apply select2 to the dropdowns in the financecodes form.
    $('#pr_items_modal_div').on('shown.bs.modal', function (e) {
        $("#id_fund_code").select2();
        $("#id_dept_code").select2();
        $("#id_office_code").select2();
        $("#id_quantity_requested").focus();
    });


    // When the Edit Item Button is clicked, load the ItemUpdateViewForm in a modal.
    $('#pr_items_table').on('click', '#edit_item_link', function(e) {
        e.preventDefault();
        var item_id = $(this).data("itemId");
        $("#id_finance_codes_form #id_item_id").val(item_id);
        $("#pr_items_modal_content_div").load($(this).attr("href"));
        $('#pr_items_modal_div').modal('show');
    });


    // When the Add Item Button is clicked, load the ItemCreateViewForm in a modal.
    $('#pr_panel_footer_div').on('click', '#add_item_link', function(e) {
        e.preventDefault();
        $("#pr_items_modal_content_div").load($(this).attr("href"), function(response, status, xhr) {
            //console.log(xhr.status + " " + xhr.statusText + " " +  status);
            $('#pr_items_tabs_ul a[href="#financecodes_tab"]').hide();
        });
        $('#pr_items_modal_div').modal('show');
    });


    // Submit ItemForm via AJAX for adding and editing ITEMS of a PR.
    $('#pr_items_modal_div').on('submit', '#id_pr_item_form', function(e) {
        e.preventDefault();
        var form_url = $(this).attr('action');
        var form_data = $(this).serialize();
        $.ajax( {method: 'POST', url: form_url, data: form_data,  global: false, } )
            .done(function(data, textStatus, jqXHR) {
                var item = data['object'][0];
                // Set the item_id field in the FinanceCodes form to populate the m2m rel.
                $("#id_finance_codes_form #id_item_id").val(item['id']);
                var url = "{% url 'financecodes_new' 0 %}";
                url = url.replace('0', item['id']);
                $("#id_finance_codes_form").attr("action",  url);

                // Show the Finance Codes tab now and switch to it.
                $('#pr_items_tabs_ul a[href="#financecodes_tab"]').show();
                $('#pr_items_tabs_ul a[href="#financecodes_tab"]').trigger('click');
                
                // Show django messages that may have been set in the View.
                var json = $.parseJSON(jqXHR.responseText);
                show_django_ajax_messages(json, "#modal_messages");
            });
    });


    // Submit FinanceCodes Form via AJAX for adding and editing of finance codes.
    $('#pr_items_modal_div').on('submit', '#id_finance_codes_form', function(event) {
        event.preventDefault();
        var form_url = $(this).attr('action');
        var form_data = $(this).serialize();

        $.ajax( {method: 'POST', url: form_url, data: form_data,  global: false, } )
            .done(function(data, textStatus, jqXHR) {

                // Show django messages that may have been set in the View.
                var json = $.parseJSON(jqXHR.responseText);
                show_django_ajax_messages(json, "#modal_messages");

                var fcid_editted = $("#id_submit_finance_codes_btn").data()['fcid'];
                // if fcid is set, it's an update so find & update a row in the table instead of appending it.
                if (fcid_editted != undefined) {
                    //console.log("fcid_editted: " + fcid_editted);
                    $("#finance_codes_table").find('tr').each(function (i, el) {
                        var $tds = $(this).find('td'), fcid = $tds.eq(1).text(); 
                        if (fcid_editted == fcid) {
                            $tds.eq(2).html($("#id_gl_account").val());  // GL Account
                            $tds.eq(3).html($("#id_fund_code").val()); // FundCodeId
                            $tds.eq(4).html($( "#id_fund_code option:selected" ).text()); // FundCode
                            $tds.eq(5).html($("#id_dept_code").val()); // DeptCodeId
                            $tds.eq(6).html($( "#id_dept_code option:selected" ).text()); // DeptCode
                            $tds.eq(7).html($("#id_office_code").val()); // OfficeCodeId
                            $tds.eq(8).html($( "#id_office_code option:selected" ).text()); // OfficeCode
                            $tds.eq(9).html($("#id_lin_code").val()); // LINCode
                            $tds.eq(10).html($("#id_activity_code").val()); // ActivityCode
                            $tds.eq(11).html($("#id_employee_id").val()); // EmployeeId
                            $tds.eq(12).html($("#id_allocation_percent").val()); //AllocationPercent
                        }
                    });
                } else {
                    // append the new finance codes to the table.
                    finance_code = data['object'][0];
                    //console.log(finance_code);
                    var tr = "<tr class='warning'>";
                    tr += "<td style='display:none;'>" + $("#id_finance_codes_form #id_item_id").val() + '</td>';
                    tr += "<td style='display:none;'>" + finance_code['id'] + "</td>";
                    tr += "<td>" + finance_code['gl_account'] + "</td>";
                    tr += "<td style='display:none;'>" + finance_code['fund_code'] + "</td>";
                    tr += "<td>" + $( "#id_fund_code option:selected" ).text() + "</td>";
                    tr += "<td style='display:none;'>" + finance_code['dept_code'] + "</td>";
                    tr += "<td>" + $( "#id_dept_code option:selected" ).text() + "</td>";
                    tr += "<td style='display:none;'>" + finance_code['office_code'] + "</td>";
                    tr += "<td>" + $( "#id_office_code option:selected" ).text() + "</td>";
                    tr += "<td>" + finance_code['lin_code'] + "</td>";
                    tr += "<td>" + finance_code['activity_code'] + "</td>";
                    tr += "<td>" + $("#id_employee_id").val() + "</td>";
                    tr += "<td>" + finance_code['allocation_percent'] + "</td>";
                    var url = "{% url 'financecodes_edit' 0 %}";
                    url = url.replace('0', finance_code['id']);
                    tr += "<td>\
                                <a href=" + url + " data-finance-codes-id=" + finance_code['id'] + " class=\"edit\"><span class=\"glyphicon glyphicon-edit\"></span></a>\
                                <a href=" + url + " data-finance-codes-id=" + finance_code['id'] + " class=\"del\" style=\"color:red;\"><span class=\"glyphicon glyphicon-trash\"></span></a>\
                            </td>";
                    $("#finance_codes_table").append(tr);
                }
                $("#id_cancel_finance_codes_btn").trigger("click");
            });
    });
</script>
{% endblock extra_js %}
