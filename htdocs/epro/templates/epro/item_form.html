{% load crispy_forms_tags %}

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h4 class="modal-title">{% if item.pk %} Updating Item {% else %} Adding Item {% endif %}</h4>
    <span id="modal_messages"></span>
</div>
<div class="modal-body">
    <!-- Nav tabs -->
    <ul id="pr_items_tabs_ul" class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#item_tab" aria-controls="item_form" role="tab" data-toggle="tab"> Item</a>
        </li>
        <li role="presentation">
            <a href="#financecodes_tab" aria-controls="finance_codes_form" role="tab" data-toggle="tab"> Finance Codes</a>
        </li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="item_tab"><br />{% crispy form %}</div>
        <div role="tabpanel" class="tab-pane" id="financecodes_tab">
            <div class = "table-responsive">
                <table id="finance_codes_table" class="table table-bordered table-striped table-hover table-condensed">
                    <tr>
                        <th style="display:none;">item_id</th>
                        <th>GL</th>
                        <th style="display:none;">FundId</th>
                        <th>Fund</th>
                        <th style="display:none;">DeptId</th>
                        <th>Dept</th>
                        <th style="display:none;">OfficeId</th>
                        <th>Office</th>
                        <th>LIN</th>
                        <th>Activity</th>
                        <th>Emp ID</th>
                        <th>% Alloc</th>
                        <th></th>
                    </tr>
                    {% for fc in item.finance_codes.all %}
                        <tr>
                            <td style="display:none;"> {{ item.pk }} </td>
                            <td> {{ fc.gl_account }} </td>
                            <td style="display:none;"> {{ fc.fund_code.pk }} </td>
                            <td> {{ fc.fund_code }} </td>
                            <td style="display:none;"> {{ fc.dept_code.pk }} </td>
                            <td> {{ fc.dept_code }} </td>
                            <td style="display:none;"> {{ fc.office_code.pk }} </td>
                            <td> {{ fc.office_code }} </td>
                            <td> {{ fc.lin_code }} </td>
                            <td> {{ fc.activity_code }} </td>
                            <td> {{ fc.employee_id }} </td>
                            <td> {{ fc.allocation_percent }} </td>
                            <td>
                                <a href="{% url 'financecodes_edit' fc.pk %}" data-finance-codes-id={{ fc.pk }} class="edit"><span class="glyphicon glyphicon-edit"></span></a>
                                <a href={% url 'financecodes_edit' fc.pk %} data-finance-codes-id={{ fc.pk }} class="del" style="color:red;"><span class="glyphicon glyphicon-trash"></span></a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            {% crispy finance_codes_form %}
    </div>
</div>
{% block extra_js %}
<script type = "text/javascript">

    // Upon activating the Item tab, set the quantity field on focus.
    $('#pr_items_tabs_ul a[href="#item_tab"]').on('shown.bs.tab', function (e) {
        $("#id_quantity_requested").focus();
    });

    // Upon activating the FinanceCodes tab, set the GL_Account field on focus.
    $('#pr_items_tabs_ul a[href="#financecodes_tab"]').on('shown.bs.tab', function (e) {
        $("#id_gl_account").focus();
    });

    // Upon clicking the EDIT button FinanceCodes, update the FinanceCodes action url
    $('#finance_codes_table').on('click', 'a.edit', function(e) {
        e.preventDefault();

        //var finance_codes_pk = $(this).data("financeCodesId");
        $("#id_finance_codes_form").attr("action",  $(this).attr('href'));

        // Get all of the td elements and extract its values to populate the form
        var tds = $(this).closest("tr").children(); //$(tds[1]).text()        
        $("#id_gl_account").val(parseInt($(tds[1]).text()));
        $("#id_fund_code").select2().val( parseInt($(tds[2]).text()) ).trigger("change");
        $("#id_dept_code").select2().val( parseInt($(tds[4]).text()) ).trigger("change");
        $("#id_office_code").select2().val( parseInt($(tds[6]).text()) ).trigger("change");
        $("#id_lin_code").val( $(tds[8]).text() );
        $("#id_activity_code").val( $(tds[9]).text() );
        $("#id_employee_id").val( parseInt($(tds[10]).text()) );
        $("#id_allocation_percent").val( parseInt($(tds[11]).text()) );
    });

    // Upon clicking the Cancel button of the FinanceCodes form, set the FinanceCodes form action to add
    $("#id_finance_codes_form").on("click", "#id_cancel_finance_codes_btn", function(e) {

        // reset the form action to add finance codes not edit.
        $("#id_finance_codes_form").attr("action",  "{% url 'financecodes_new' item.pk %}");

        // reset the dropdowns with select2 manually b/c reset button cannot reset them.
        $("#id_fund_code").select2().val("").trigger("change");
        $("#id_dept_code").select2().val("").trigger("change");
        $("#id_office_code").select2().val("").trigger("change");
    });

</script>
{% endblock extra_js %}